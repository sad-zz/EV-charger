(kicad_sch (version 20230121) (generator eeschema)

  (uuid 9c6bd711-93fb-4c3f-9c75-1e1c8a7c58c9)

  (paper "A3")

  (title_block
    (title "AC Wallbox EV Charger - Main Schematic")
    (date "2026-01-01")
    (rev "1.0")
    (company "Iran EV Charger Project")
    (comment 1 "IEC 61851-1 Compliant")
    (comment 2 "7.4kW (1-phase) / 22kW (3-phase)")
    (comment 3 "Type 2 Connector with CP/PP")
  )

  (lib_symbols
    (symbol "MCU_ST_STM32G4:STM32G474RETx" (in_bom yes) (on_board yes)
      (property "Reference" "U" (at 0 0 0)
        (effects (font (size 1.27 1.27)))
      )
      (property "Value" "STM32G474RETx" (at 0 -2.54 0)
        (effects (font (size 1.27 1.27)))
      )
      (property "Footprint" "Package_QFP:LQFP-64_10x10mm_P0.5mm" (at 0 -5.08 0)
        (effects (font (size 1.27 1.27)) hide)
      )
      (property "Datasheet" "https://www.st.com/resource/en/datasheet/stm32g474re.pdf" (at 0 -7.62 0)
        (effects (font (size 1.27 1.27)) hide)
      )
      (property "Description" "ARM Cortex-M4 MCU, 512KB Flash, 170MHz" (at 0 -10.16 0)
        (effects (font (size 1.27 1.27)) hide)
      )
      (symbol "STM32G474RETx_0_1"
        (rectangle (start -20.32 30.48) (end 20.32 -30.48)
          (stroke (width 0.254) (type default))
          (fill (type background))
        )
      )
    )

    (symbol "Device:R" (pin_numbers hide) (pin_names (offset 0)) (in_bom yes) (on_board yes)
      (property "Reference" "R" (at 2.032 0 90)
        (effects (font (size 1.27 1.27)))
      )
      (property "Value" "R" (at 0 0 90)
        (effects (font (size 1.27 1.27)))
      )
      (property "Footprint" "" (at -1.778 0 90)
        (effects (font (size 1.27 1.27)) hide)
      )
      (symbol "R_0_1"
        (rectangle (start -1.016 -2.54) (end 1.016 2.54)
          (stroke (width 0.254) (type default))
          (fill (type none))
        )
      )
      (symbol "R_1_1"
        (pin passive line (at 0 3.81 270) (length 1.27)
          (name "~" (effects (font (size 1.27 1.27))))
          (number "1" (effects (font (size 1.27 1.27))))
        )
        (pin passive line (at 0 -3.81 90) (length 1.27)
          (name "~" (effects (font (size 1.27 1.27))))
          (number "2" (effects (font (size 1.27 1.27))))
        )
      )
    )

    (symbol "Device:C" (pin_numbers hide) (pin_names (offset 0.254)) (in_bom yes) (on_board yes)
      (property "Reference" "C" (at 0.635 2.54 0)
        (effects (font (size 1.27 1.27)) (justify left))
      )
      (property "Value" "C" (at 0.635 -2.54 0)
        (effects (font (size 1.27 1.27)) (justify left))
      )
      (symbol "C_0_1"
        (polyline
          (pts
            (xy -2.032 -0.762)
            (xy 2.032 -0.762)
          )
          (stroke (width 0.508) (type default))
          (fill (type none))
        )
        (polyline
          (pts
            (xy -2.032 0.762)
            (xy 2.032 0.762)
          )
          (stroke (width 0.508) (type default))
          (fill (type none))
        )
      )
      (symbol "C_1_1"
        (pin passive line (at 0 3.81 270) (length 2.794)
          (name "~" (effects (font (size 1.27 1.27))))
          (number "1" (effects (font (size 1.27 1.27))))
        )
        (pin passive line (at 0 -3.81 90) (length 2.794)
          (name "~" (effects (font (size 1.27 1.27))))
          (number "2" (effects (font (size 1.27 1.27))))
        )
      )
    )
  )

  (junction (at 60.96 50.8) (diameter 0) (color 0 0 0 0)
    (uuid 4f3c5e72-1234-4567-89ab-cdef01234567)
  )

  (text "AC Wallbox Control Board\n\nMain sections:\n- Power Supply (12V/5V/3.3V/-12V)\n- MCU (STM32G474)\n- CP/PP Interface\n- Current Sensing (CT)\n- Voltage Sensing\n- RCM Interface\n- Contactor Control\n- Communication (Ethernet/4G)\n- HMI (OLED/RFID)"
    (at 15.24 10.16 0)
    (effects (font (size 2.54 2.54)) (justify left))
    (uuid text-main-description)
  )

  (hierarchical_label "AC_L" (shape input) (at 25.4 40.64 180) (fields_autoplaced)
    (effects (font (size 1.27 1.27)) (justify right))
    (uuid hl-ac-l)
  )
  (hierarchical_label "AC_N" (shape input) (at 25.4 43.18 180) (fields_autoplaced)
    (effects (font (size 1.27 1.27)) (justify right))
    (uuid hl-ac-n)
  )
  (hierarchical_label "PE" (shape input) (at 25.4 45.72 180) (fields_autoplaced)
    (effects (font (size 1.27 1.27)) (justify right))
    (uuid hl-pe)
  )
  (hierarchical_label "CP_OUT" (shape output) (at 200.66 50.8 0) (fields_autoplaced)
    (effects (font (size 1.27 1.27)) (justify left))
    (uuid hl-cp-out)
  )
  (hierarchical_label "PP_SENSE" (shape input) (at 200.66 60.96 0) (fields_autoplaced)
    (effects (font (size 1.27 1.27)) (justify left))
    (uuid hl-pp-sense)
  )

  (sheet (at 40.64 100.33) (size 38.1 20.32) (fields_autoplaced)
    (stroke (width 0.1524) (type solid))
    (fill (color 0 0 0 0.0000))
    (uuid sheet-power-supply)
    (property "Sheetname" "Power Supply" (at 40.64 99.6184 0)
      (effects (font (size 1.27 1.27)) (justify left bottom))
    )
    (property "Sheetfile" "power-supply.kicad_sch" (at 40.64 121.2346 0)
      (effects (font (size 1.27 1.27)) (justify left top))
    )
    (pin "AC_IN" input (at 40.64 105.41 180)
      (effects (font (size 1.27 1.27)) (justify left))
      (uuid pin-ac-in)
    )
    (pin "+12V" output (at 78.74 105.41 0)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-12v-out)
    )
    (pin "+5V" output (at 78.74 109.22 0)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-5v-out)
    )
    (pin "+3.3V" output (at 78.74 113.03 0)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-3v3-out)
    )
    (pin "-12V" output (at 78.74 116.84 0)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-neg12v-out)
    )
    (pin "GND" output (at 59.69 120.65 270)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-gnd-out)
    )
  )

  (sheet (at 100.33 40.64) (size 40.64 30.48) (fields_autoplaced)
    (stroke (width 0.1524) (type solid))
    (fill (color 0 0 0 0.0000))
    (uuid sheet-cp-pp)
    (property "Sheetname" "CP/PP Interface" (at 100.33 39.9284 0)
      (effects (font (size 1.27 1.27)) (justify left bottom))
    )
    (property "Sheetfile" "cp-pp-interface.kicad_sch" (at 100.33 71.7046 0)
      (effects (font (size 1.27 1.27)) (justify left top))
    )
    (pin "PWM_IN" input (at 100.33 45.72 180)
      (effects (font (size 1.27 1.27)) (justify left))
      (uuid pin-pwm-in)
    )
    (pin "CP_SENSE" output (at 100.33 50.8 180)
      (effects (font (size 1.27 1.27)) (justify left))
      (uuid pin-cp-sense)
    )
    (pin "PP_SENSE" output (at 100.33 55.88 180)
      (effects (font (size 1.27 1.27)) (justify left))
      (uuid pin-pp-sense)
    )
    (pin "CP_OUT" output (at 140.97 45.72 0)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-cp-out-conn)
    )
    (pin "PP_OUT" output (at 140.97 50.8 0)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-pp-out-conn)
    )
    (pin "+12V" input (at 120.65 40.64 90)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-12v-in-cp)
    )
    (pin "-12V" input (at 125.73 40.64 90)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-neg12v-in-cp)
    )
    (pin "GND" input (at 120.65 71.12 270)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-gnd-cp)
    )
  )

  (sheet (at 100.33 85.09) (size 38.1 25.4) (fields_autoplaced)
    (stroke (width 0.1524) (type solid))
    (fill (color 0 0 0 0.0000))
    (uuid sheet-current-sensing)
    (property "Sheetname" "Current Sensing" (at 100.33 84.3784 0)
      (effects (font (size 1.27 1.27)) (justify left bottom))
    )
    (property "Sheetfile" "current-sensing.kicad_sch" (at 100.33 111.0746 0)
      (effects (font (size 1.27 1.27)) (justify left top))
    )
    (pin "CT_L1" input (at 100.33 90.17 180)
      (effects (font (size 1.27 1.27)) (justify left))
      (uuid pin-ct-l1)
    )
    (pin "CT_L2" input (at 100.33 93.98 180)
      (effects (font (size 1.27 1.27)) (justify left))
      (uuid pin-ct-l2)
    )
    (pin "CT_L3" input (at 100.33 97.79 180)
      (effects (font (size 1.27 1.27)) (justify left))
      (uuid pin-ct-l3)
    )
    (pin "I_SENSE_1" output (at 138.43 90.17 0)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-i-sense-1)
    )
    (pin "I_SENSE_2" output (at 138.43 93.98 0)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-i-sense-2)
    )
    (pin "I_SENSE_3" output (at 138.43 97.79 0)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-i-sense-3)
    )
    (pin "+5V" input (at 119.38 85.09 90)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-5v-ct)
    )
    (pin "GND" input (at 119.38 110.49 270)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-gnd-ct)
    )
  )

  (sheet (at 155.45 85.09) (size 35.56 25.4) (fields_autoplaced)
    (stroke (width 0.1524) (type solid))
    (fill (color 0 0 0 0.0000))
    (uuid sheet-mcu)
    (property "Sheetname" "MCU STM32G474" (at 155.45 84.3784 0)
      (effects (font (size 1.27 1.27)) (justify left bottom))
    )
    (property "Sheetfile" "mcu.kicad_sch" (at 155.45 111.0746 0)
      (effects (font (size 1.27 1.27)) (justify left top))
    )
    (pin "PWM_CP" output (at 155.45 90.17 180)
      (effects (font (size 1.27 1.27)) (justify left))
      (uuid pin-pwm-cp-mcu)
    )
    (pin "ADC_CP" input (at 155.45 93.98 180)
      (effects (font (size 1.27 1.27)) (justify left))
      (uuid pin-adc-cp-mcu)
    )
    (pin "ADC_PP" input (at 155.45 97.79 180)
      (effects (font (size 1.27 1.27)) (justify left))
      (uuid pin-adc-pp-mcu)
    )
    (pin "I2C_SDA" bidirectional (at 191.01 90.17 0)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-i2c-sda)
    )
    (pin "I2C_SCL" output (at 191.01 93.98 0)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-i2c-scl)
    )
    (pin "SPI_MOSI" output (at 191.01 100.33 0)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-spi-mosi)
    )
    (pin "SPI_MISO" input (at 191.01 104.14 0)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-spi-miso)
    )
    (pin "SPI_SCK" output (at 191.01 107.95 0)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-spi-sck)
    )
    (pin "+3.3V" input (at 173.23 85.09 90)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-3v3-mcu)
    )
    (pin "GND" input (at 173.23 110.49 270)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-gnd-mcu)
    )
  )

  (symbol (lib_id "Device:R") (at 60.96 55.88 0) (unit 1)
    (in_bom yes) (on_board yes) (dnp no)
    (uuid resistor-example)
    (property "Reference" "R1" (at 63.5 54.61 0)
      (effects (font (size 1.27 1.27)) (justify left))
    )
    (property "Value" "10k" (at 63.5 57.15 0)
      (effects (font (size 1.27 1.27)) (justify left))
    )
    (property "Footprint" "Resistor_SMD:R_0805_2012Metric" (at 59.182 55.88 90)
      (effects (font (size 1.27 1.27)) hide)
    )
    (pin "1" (uuid res-pin1))
    (pin "2" (uuid res-pin2))
  )

  (wire (pts (xy 60.96 50.8) (xy 60.96 52.07))
    (stroke (width 0) (type default))
    (uuid wire-example-1)
  )

  (wire (pts (xy 60.96 59.69) (xy 60.96 63.5))
    (stroke (width 0) (type default))
    (uuid wire-example-2)
  )

  (global_label "GND" (shape input) (at 60.96 63.5 270) (fields_autoplaced)
    (effects (font (size 1.27 1.27)) (justify right))
    (uuid global-gnd)
  )

)
