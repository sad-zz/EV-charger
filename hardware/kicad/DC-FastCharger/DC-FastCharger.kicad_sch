(kicad_sch (version 20230121) (generator eeschema)

  (uuid a1b2c3d4-5e6f-7g8h-9i0j-k1l2m3n4o5p6)

  (paper "A2")

  (title_block
    (title "DC Fast Charger - Main Control Schematic")
    (date "2026-01-01")
    (rev "1.0")
    (company "Iran EV Charger Project")
    (comment 1 "IEC 61851-23/24 & ISO 15118 Compliant")
    (comment 2 "60-120kW CCS2 DC Charging")
    (comment 3 "Dual MCU Architecture: Safety + Main SoM")
  )

  (lib_symbols
    (symbol "MCU_ST_STM32F7:STM32F765VITx" (in_bom yes) (on_board yes)
      (property "Reference" "U" (at 0 0 0)
        (effects (font (size 1.27 1.27)))
      )
      (property "Value" "STM32F765VITx" (at 0 -2.54 0)
        (effects (font (size 1.27 1.27)))
      )
      (property "Footprint" "Package_QFP:LQFP-100_14x14mm_P0.5mm" (at 0 -5.08 0)
        (effects (font (size 1.27 1.27)) hide)
      )
      (property "Description" "Safety MCU - ARM Cortex-M7 216MHz" (at 0 -7.62 0)
        (effects (font (size 1.27 1.27)) hide)
      )
      (symbol "STM32F765VITx_0_1"
        (rectangle (start -25.4 35.56) (end 25.4 -35.56)
          (stroke (width 0.254) (type default))
          (fill (type background))
        )
      )
    )
  )

  (text "DC Fast Charger Control Board\n\nMain Sections:\n\n1. Safety MCU (STM32F765)\n   - Pre-charge control\n   - Contactor management\n   - IMD/RISO monitoring\n   - Current/Voltage sensing\n   - Emergency stop\n\n2. Main SoM (i.MX8M Mini)\n   - OCPP 2.0.1 client\n   - HMI (7\" display)\n   - ISO 15118 stack\n   - Backend communication\n\n3. PLC Module (QCA7005)\n   - Green PHY modem\n   - ISO 15118 physical layer\n   - CCS2 communication\n\n4. Power Interface\n   - 3-4x DC/DC modules (CAN)\n   - IMD (Bender)\n   - DC Leakage (RCM-DC)\n   - HV sensing (800V)\n\n5. Safety Systems\n   - Pre-charge resistor\n   - DC contactors (3x)\n   - E-Stop circuit\n   - Interlocks"
    (at 20.32 15.24 0)
    (effects (font (size 2.0 2.0)) (justify left))
    (uuid text-main-description)
  )

  (hierarchical_label "DC_BUS+" (shape input) (at 30.48 50.8 180) (fields_autoplaced)
    (effects (font (size 2.0 2.0) bold) (justify right))
    (uuid hl-dc-bus-pos)
  )
  (hierarchical_label "DC_BUS-" (shape input) (at 30.48 58.42 180) (fields_autoplaced)
    (effects (font (size 2.0 2.0) bold) (justify right))
    (uuid hl-dc-bus-neg)
  )
  (hierarchical_label "DC_OUT+" (shape output) (at 250.0 50.8 0) (fields_autoplaced)
    (effects (font (size 2.0 2.0) bold) (justify left))
    (uuid hl-dc-out-pos)
  )
  (hierarchical_label "DC_OUT-" (shape output) (at 250.0 58.42 0) (fields_autoplaced)
    (effects (font (size 2.0 2.0) bold) (justify left))
    (uuid hl-dc-out-neg)
  )
  (hierarchical_label "CP" (shape bidirectional) (at 250.0 80.0 0) (fields_autoplaced)
    (effects (font (size 1.27 1.27)) (justify left))
    (uuid hl-cp)
  )
  (hierarchical_label "PP" (shape input) (at 250.0 85.0 0) (fields_autoplaced)
    (effects (font (size 1.27 1.27)) (justify left))
    (uuid hl-pp)
  )

  (sheet (at 50.8 120.0) (size 50.8 35.56) (fields_autoplaced)
    (stroke (width 0.1524) (type solid))
    (fill (color 0 0 0 0.0000))
    (uuid sheet-safety-mcu)
    (property "Sheetname" "Safety MCU (STM32F765)" (at 50.8 119.2884 0)
      (effects (font (size 1.5 1.5) bold) (justify left bottom))
    )
    (property "Sheetfile" "safety-mcu.kicad_sch" (at 50.8 156.1446 0)
      (effects (font (size 1.27 1.27)) (justify left top))
    )
    (pin "CAN1_TX" output (at 101.6 125.0 0)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-can1-tx)
    )
    (pin "CAN1_RX" input (at 101.6 128.0 0)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-can1-rx)
    )
    (pin "CAN2_TX" output (at 101.6 135.0 0)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-can2-tx)
    )
    (pin "CAN2_RX" input (at 101.6 138.0 0)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-can2-rx)
    )
    (pin "PRECHARGE_CTRL" output (at 50.8 130.0 180)
      (effects (font (size 1.27 1.27)) (justify left))
      (uuid pin-precharge-ctrl)
    )
    (pin "K1_CTRL" output (at 50.8 135.0 180)
      (effects (font (size 1.27 1.27)) (justify left))
      (uuid pin-k1-ctrl)
    )
    (pin "K2_CTRL" output (at 50.8 138.0 180)
      (effects (font (size 1.27 1.27)) (justify left))
      (uuid pin-k2-ctrl)
    )
    (pin "K3_CTRL" output (at 50.8 141.0 180)
      (effects (font (size 1.27 1.27)) (justify left))
      (uuid pin-k3-ctrl)
    )
    (pin "V_DC_BUS" input (at 76.2 155.56 270)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-v-dc-bus)
    )
    (pin "V_DC_OUT" input (at 81.28 155.56 270)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-v-dc-out)
    )
    (pin "I_DC_OUT" input (at 86.36 155.56 270)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-i-dc-out)
    )
    (pin "IMD_STATUS" input (at 91.44 155.56 270)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-imd-status)
    )
    (pin "E_STOP" input (at 96.52 155.56 270)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-e-stop)
    )
  )

  (sheet (at 120.0 120.0) (size 50.8 35.56) (fields_autoplaced)
    (stroke (width 0.1524) (type solid))
    (fill (color 0 0 0 0.0000))
    (uuid sheet-main-som)
    (property "Sheetname" "Main SoM (i.MX8M Mini)" (at 120.0 119.2884 0)
      (effects (font (size 1.5 1.5) bold) (justify left bottom))
    )
    (property "Sheetfile" "main-som.kicad_sch" (at 120.0 156.1446 0)
      (effects (font (size 1.27 1.27)) (justify left top))
    )
    (pin "CAN_TX" output (at 120.0 125.0 180)
      (effects (font (size 1.27 1.27)) (justify left))
      (uuid pin-som-can-tx)
    )
    (pin "CAN_RX" input (at 120.0 128.0 180)
      (effects (font (size 1.27 1.27)) (justify left))
      (uuid pin-som-can-rx)
    )
    (pin "ETH_TX+" output (at 170.8 125.0 0)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-eth-txp)
    )
    (pin "ETH_TX-" output (at 170.8 128.0 0)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-eth-txn)
    )
    (pin "ETH_RX+" input (at 170.8 132.0 0)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-eth-rxp)
    )
    (pin "ETH_RX-" input (at 170.8 135.0 0)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-eth-rxn)
    )
    (pin "DISPLAY_DSI" output (at 170.8 145.0 0)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-display)
    )
    (pin "I2C_SDA" bidirectional (at 145.0 155.56 270)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-i2c-sda-som)
    )
    (pin "I2C_SCL" output (at 150.0 155.56 270)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-i2c-scl-som)
    )
  )

  (sheet (at 50.8 170.0) (size 45.0 25.0) (fields_autoplaced)
    (stroke (width 0.1524) (type solid))
    (fill (color 0 0 0 0.0000))
    (uuid sheet-contactors)
    (property "Sheetname" "DC Contactors & Pre-charge" (at 50.8 169.2884 0)
      (effects (font (size 1.5 1.5) bold) (justify left bottom))
    )
    (property "Sheetfile" "contactors.kicad_sch" (at 50.8 195.5846 0)
      (effects (font (size 1.27 1.27)) (justify left top))
    )
    (pin "DC_IN+" input (at 50.8 175.0 180)
      (effects (font (size 1.5 1.5) bold) (justify left))
      (uuid pin-dc-in-pos)
    )
    (pin "DC_IN-" input (at 50.8 180.0 180)
      (effects (font (size 1.5 1.5) bold) (justify left))
      (uuid pin-dc-in-neg)
    )
    (pin "DC_OUT+" output (at 95.8 175.0 0)
      (effects (font (size 1.5 1.5) bold) (justify right))
      (uuid pin-dc-out-pos-cont)
    )
    (pin "DC_OUT-" output (at 95.8 180.0 0)
      (effects (font (size 1.5 1.5) bold) (justify right))
      (uuid pin-dc-out-neg-cont)
    )
    (pin "K1_DRIVE" input (at 73.0 195.0 270)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-k1-drive)
    )
    (pin "K2_DRIVE" input (at 78.0 195.0 270)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-k2-drive)
    )
    (pin "K3_DRIVE" input (at 83.0 195.0 270)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-k3-drive)
    )
  )

  (sheet (at 120.0 170.0) (size 45.0 25.0) (fields_autoplaced)
    (stroke (width 0.1524) (type solid))
    (fill (color 0 0 0 0.0000))
    (uuid sheet-sensing)
    (property "Sheetname" "DC Sensing (V/I/IMD)" (at 120.0 169.2884 0)
      (effects (font (size 1.5 1.5) bold) (justify left bottom))
    )
    (property "Sheetfile" "dc-sensing.kicad_sch" (at 120.0 195.5846 0)
      (effects (font (size 1.27 1.27)) (justify left top))
    )
    (pin "V_BUS_MEAS" output (at 165.0 175.0 0)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-v-bus-meas)
    )
    (pin "V_OUT_MEAS" output (at 165.0 180.0 0)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-v-out-meas)
    )
    (pin "I_OUT_MEAS" output (at 165.0 185.0 0)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-i-out-meas)
    )
    (pin "IMD_FAULT" output (at 165.0 190.0 0)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-imd-fault)
    )
    (pin "DC_BUS" input (at 120.0 175.0 180)
      (effects (font (size 1.27 1.27)) (justify left))
      (uuid pin-dc-bus-sense)
    )
    (pin "DC_OUT" input (at 120.0 180.0 180)
      (effects (font (size 1.27 1.27)) (justify left))
      (uuid pin-dc-out-sense)
    )
  )

  (sheet (at 190.0 120.0) (size 40.0 30.0) (fields_autoplaced)
    (stroke (width 0.1524) (type solid))
    (fill (color 0 0 0 0.0000))
    (uuid sheet-plc)
    (property "Sheetname" "PLC Module (ISO 15118)" (at 190.0 119.2884 0)
      (effects (font (size 1.5 1.5) bold) (justify left bottom))
    )
    (property "Sheetfile" "plc-iso15118.kicad_sch" (at 190.0 150.5846 0)
      (effects (font (size 1.27 1.27)) (justify left top))
    )
    (pin "CP_LINE" bidirectional (at 230.0 130.0 0)
      (effects (font (size 1.27 1.27)) (justify right))
      (uuid pin-cp-line)
    )
    (pin "SPI_MOSI" input (at 190.0 130.0 180)
      (effects (font (size 1.27 1.27)) (justify left))
      (uuid pin-plc-mosi)
    )
    (pin "SPI_MISO" output (at 190.0 133.0 180)
      (effects (font (size 1.27 1.27)) (justify left))
      (uuid pin-plc-miso)
    )
    (pin "SPI_SCK" input (at 190.0 136.0 180)
      (effects (font (size 1.27 1.27)) (justify left))
      (uuid pin-plc-sck)
    )
    (pin "SPI_CS" input (at 190.0 139.0 180)
      (effects (font (size 1.27 1.27)) (justify left))
      (uuid pin-plc-cs)
    )
  )

  (gr_text "DANGER: HIGH VOLTAGE\n800V DC BUS\nOnly trained personnel" (at 140.0 60.0 0) (layer "Cmts.User")
    (effects (font (size 5.0 5.0) (thickness 1.0) bold) (justify center))
    (uuid warning-hv)
  )

)
